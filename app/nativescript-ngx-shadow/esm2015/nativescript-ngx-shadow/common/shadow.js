/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Color } from 'tns-core-modules/color';
import { ShapeEnum } from './shape.enum';
import { Length } from 'tns-core-modules/ui/page/page';
import { isAndroid, screen } from "tns-core-modules/platform";
/** @type {?} */
let LayeredShadow;
/** @type {?} */
let PlainShadow;
if (isAndroid) {
    LayeredShadow = android.graphics.drawable.LayerDrawable.extend({});
    PlainShadow = android.graphics.drawable.GradientDrawable.extend({});
}
/** @type {?} */
const classCache = {};
/**
 * @param {?} rtype
 * @param {?} field
 * @return {?}
 */
function getAndroidR(rtype, field) {
    /** @type {?} */
    const className = "android.R$" + rtype;
    if (!classCache.hasOwnProperty(className)) {
        classCache[className] = {
            class: java.lang.Class.forName(className),
            fieldCache: {}
        };
    }
    if (!classCache[className].fieldCache.hasOwnProperty(field)) {
        classCache[className].fieldCache[field] = +classCache[className].class.getField(field).get(null);
    }
    return classCache[className].fieldCache[field];
}
export class Shadow {
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static apply(tnsView, data) {
        /** @type {?} */
        const LOLLIPOP = 21;
        if (tnsView.android &&
            android.os.Build.VERSION.SDK_INT >= LOLLIPOP) {
            Shadow.applyOnAndroid(tnsView, Shadow.getDefaults(data));
        }
        else if (tnsView.ios) {
            Shadow.applyOnIOS(tnsView, Shadow.getDefaults(data));
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    static getDefaults(data) {
        return Object.assign({}, data, {
            shape: (/** @type {?} */ (data)).shape || Shadow.DEFAULT_SHAPE,
            pressedElevation: (/** @type {?} */ (data)).pressedElevation || Shadow.DEFAULT_PRESSED_ELEVATION,
            pressedTranslationZ: (/** @type {?} */ (data)).pressedTranslationZ || Shadow.DEFAULT_PRESSED_ELEVATION,
            shadowColor: (/** @type {?} */ (data)).shadowColor ||
                Shadow.DEFAULT_SHADOW_COLOR,
            useShadowPath: ((/** @type {?} */ (data)).useShadowPath !== undefined ? (/** @type {?} */ (data)).useShadowPath : true),
            rasterize: ((/** @type {?} */ (data)).rasterize !== undefined ? (/** @type {?} */ (data)).rasterize : false)
        });
    }
    /**
     * @param {?} drawable
     * @return {?}
     */
    static isShadow(drawable) {
        return (drawable instanceof LayeredShadow || drawable instanceof PlainShadow);
    }
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static applyOnAndroid(tnsView, data) {
        /** @type {?} */
        const nativeView = tnsView.android;
        /** @type {?} */
        let shape;
        /** @type {?} */
        let overrideBackground = true;
        /** @type {?} */
        let currentBg = nativeView.getBackground();
        if (currentBg instanceof android.graphics.drawable.RippleDrawable) {
            /** @type {?} */
            let rippleBg = currentBg.getDrawable(0);
            if (rippleBg instanceof android.graphics.drawable.InsetDrawable) {
                overrideBackground = false; // this is a button with it's own shadow
            }
            else if (Shadow.isShadow(rippleBg)) {
                // if the ripple is wrapping a shadow, strip it
                currentBg = rippleBg;
            }
        }
        if (overrideBackground) {
            if (Shadow.isShadow(currentBg)) {
                // make sure to have the right background
                currentBg = currentBg instanceof LayeredShadow ? // if layered, get the original background
                    currentBg.getDrawable(1) : null;
            }
            /** @type {?} */
            const outerRadii = Array.create("float", 8);
            if (data.cornerRadius === undefined) {
                outerRadii[0] = outerRadii[1] = Length.toDevicePixels(tnsView.borderTopLeftRadius, 0);
                outerRadii[2] = outerRadii[3] = Length.toDevicePixels(tnsView.borderTopRightRadius, 0);
                outerRadii[4] = outerRadii[5] = Length.toDevicePixels(tnsView.borderBottomRightRadius, 0);
                outerRadii[6] = outerRadii[7] = Length.toDevicePixels(tnsView.borderBottomLeftRadius, 0);
            }
            else {
                java.util.Arrays.fill(outerRadii, Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.cornerRadius)));
            }
            /** @type {?} */
            const bgColor = currentBg ?
                (currentBg instanceof android.graphics.drawable.ColorDrawable && currentBg.getColor() ?
                    currentBg.getColor() : android.graphics.Color.parseColor(data.bgcolor || Shadow.DEFAULT_BGCOLOR)) :
                android.graphics.Color.parseColor(data.bgcolor || Shadow.DEFAULT_BGCOLOR);
            /** @type {?} */
            let newBg;
            if (data.shape !== ShapeEnum.RECTANGLE || data.bgcolor || !currentBg) {
                // replace background
                shape = new PlainShadow();
                shape.setShape(android.graphics.drawable.GradientDrawable[data.shape]);
                shape.setCornerRadii(outerRadii);
                shape.setColor(bgColor);
                newBg = shape;
            }
            else {
                /** @type {?} */
                const r = new android.graphics.drawable.shapes.RoundRectShape(outerRadii, null, null);
                shape = new android.graphics.drawable.ShapeDrawable(r);
                shape.getPaint().setColor(bgColor);
                /** @type {?} */
                var arr = Array.create(android.graphics.drawable.Drawable, 2);
                arr[0] = shape;
                arr[1] = currentBg;
                /** @type {?} */
                const drawable = new LayeredShadow(arr);
                newBg = drawable;
            }
            nativeView.setBackgroundDrawable(newBg);
        }
        nativeView.setElevation(Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.elevation)));
        nativeView.setTranslationZ(Shadow.androidDipToPx(nativeView, /** @type {?} */ (data.translationZ)));
        if (nativeView.getStateListAnimator() || data.forcePressAnimation) {
            this.overrideDefaultAnimator(nativeView, data);
        }
    }
    /**
     * @param {?} nativeView
     * @param {?} data
     * @return {?}
     */
    static overrideDefaultAnimator(nativeView, data) {
        /** @type {?} */
        const sla = new android.animation.StateListAnimator();
        /** @type {?} */
        const ObjectAnimator = android.animation.ObjectAnimator;
        /** @type {?} */
        const AnimatorSet = android.animation.AnimatorSet;
        /** @type {?} */
        const shortAnimTime = getAndroidR("integer", "config_shortAnimTime");
        /** @type {?} */
        const buttonDuration = nativeView.getContext().getResources().getInteger(shortAnimTime) / 2;
        /** @type {?} */
        const pressedElevation = this.androidDipToPx(nativeView, data.pressedElevation);
        /** @type {?} */
        const pressedZ = this.androidDipToPx(nativeView, data.pressedTranslationZ);
        /** @type {?} */
        const elevation = this.androidDipToPx(nativeView, data.elevation);
        /** @type {?} */
        const z = this.androidDipToPx(nativeView, data.translationZ || 0);
        /** @type {?} */
        const pressedSet = new AnimatorSet();
        /** @type {?} */
        const notPressedSet = new AnimatorSet();
        /** @type {?} */
        const defaultSet = new AnimatorSet();
        pressedSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [pressedZ])
                .setDuration(buttonDuration),
            ObjectAnimator.ofFloat(nativeView, "elevation", [pressedElevation])
                .setDuration(0),
        ]));
        notPressedSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [z])
                .setDuration(buttonDuration),
            ObjectAnimator.ofFloat(nativeView, "elevation", [elevation])
                .setDuration(0),
        ]));
        defaultSet.playTogether(java.util.Arrays.asList([
            ObjectAnimator.ofFloat(nativeView, "translationZ", [0]).setDuration(0),
            ObjectAnimator.ofFloat(nativeView, "elevation", [0]).setDuration(0),
        ]));
        sla.addState([getAndroidR("attr", "state_pressed"), getAndroidR("attr", "state_enabled")], pressedSet);
        sla.addState([getAndroidR("attr", "state_enabled")], notPressedSet);
        sla.addState([], defaultSet);
        nativeView.setStateListAnimator(sla);
    }
    /**
     * @param {?} tnsView
     * @param {?} data
     * @return {?}
     */
    static applyOnIOS(tnsView, data) {
        /** @type {?} */
        const nativeView = tnsView.ios;
        /** @type {?} */
        const elevation = parseFloat(((/** @type {?} */ (data.elevation)) - 0).toFixed(2));
        nativeView.layer.maskToBounds = false;
        nativeView.layer.shadowColor = new Color(data.shadowColor).ios.CGColor;
        nativeView.layer.shadowOffset =
            data.shadowOffset ?
                CGSizeMake(0, parseFloat(String(data.shadowOffset))) :
                CGSizeMake(0, 0.54 * elevation - 0.14);
        nativeView.layer.shadowOpacity =
            data.shadowOpacity ?
                parseFloat(String(data.shadowOpacity)) :
                0.006 * elevation + 0.25;
        nativeView.layer.shadowRadius =
            data.shadowRadius ?
                parseFloat(String(data.shadowRadius)) :
                0.66 * elevation - 0.5;
        nativeView.layer.shouldRasterize = data.rasterize;
        nativeView.layer.rasterizationScale = screen.mainScreen.scale;
        /** @type {?} */
        let shadowPath = null;
        if (data.useShadowPath) {
            shadowPath = UIBezierPath.bezierPathWithRoundedRectCornerRadius(nativeView.bounds, nativeView.layer.shadowRadius).cgPath;
        }
        nativeView.layer.shadowPath = shadowPath;
    }
    /**
     * @param {?} nativeView
     * @param {?} dip
     * @return {?}
     */
    static androidDipToPx(nativeView, dip) {
        /** @type {?} */
        const metrics = nativeView.getContext().getResources().getDisplayMetrics();
        return android.util.TypedValue.applyDimension(android.util.TypedValue.COMPLEX_UNIT_DIP, dip, metrics);
    }
}
Shadow.DEFAULT_SHAPE = ShapeEnum.RECTANGLE;
Shadow.DEFAULT_BGCOLOR = '#FFFFFF';
Shadow.DEFAULT_SHADOW_COLOR = '#000000';
Shadow.DEFAULT_PRESSED_ELEVATION = 2;
Shadow.DEFAULT_PRESSED_Z = 4;
if (false) {
    /** @type {?} */
    Shadow.DEFAULT_SHAPE;
    /** @type {?} */
    Shadow.DEFAULT_BGCOLOR;
    /** @type {?} */
    Shadow.DEFAULT_SHADOW_COLOR;
    /** @type {?} */
    Shadow.DEFAULT_PRESSED_ELEVATION;
    /** @type {?} */
    Shadow.DEFAULT_PRESSED_Z;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZG93LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmF0aXZlc2NyaXB0LW5neC1zaGFkb3cvIiwic291cmNlcyI6WyJuYXRpdmVzY3JpcHQtbmd4LXNoYWRvdy9jb21tb24vc2hhZG93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFJL0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7QUFTOUQsSUFBSSxhQUFhLENBQUM7O0FBQ2xCLElBQUksV0FBVyxDQUFDO0FBRWhCLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDZCxhQUFhLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNuRSxXQUFXLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ3JFOztBQUVELE1BQU0sVUFBVSxHQUEyRSxFQUFFLENBQUM7Ozs7OztBQUU5RixxQkFBcUIsS0FBYSxFQUFFLEtBQWE7O0lBQy9DLE1BQU0sU0FBUyxHQUFHLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDdkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQyxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUc7WUFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7WUFDekMsVUFBVSxFQUFFLEVBQUU7U0FDZixDQUFDO0tB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Q0osQ0FBQzsyQkFDVCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sb3IgfSBmcm9tICd0bnMtY29yZS1tb2R1bGVzL2NvbG9yJztcblxuaW1wb3J0IHsgQW5kcm9pZERhdGEgfSBmcm9tIFwiLi9hbmRyb2lkLWRhdGEubW9kZWxcIjtcbmltcG9ydCB7IElPU0RhdGEgfSBmcm9tIFwiLi9pb3MtZGF0YS5tb2RlbFwiO1xuaW1wb3J0IHsgU2hhcGVFbnVtIH0gZnJvbSAnLi9zaGFwZS5lbnVtJztcbmltcG9ydCB7IExlbmd0aCB9IGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvdWkvcGFnZS9wYWdlJztcbmltcG9ydCB7IGlzQW5kcm9pZCwgc2NyZWVuIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvcGxhdGZvcm1cIjtcblxuZGVjbGFyZSBjb25zdCBhbmRyb2lkOiBhbnk7XG5kZWNsYXJlIGNvbnN0IGphdmE6IGFueTtcbmRlY2xhcmUgY29uc3QgQ0dTaXplTWFrZTogYW55O1xuZGVjbGFyZSBjb25zdCBVSVNjcmVlbjogYW55O1xuZGVjbGFyZSBjb25zdCBBcnJheTogYW55O1xuZGVjbGFyZSBjb25zdCBVSUJlemllclBhdGg6IGFueTtcblxubGV0IExheWVyZWRTaGFkb3c7XG5sZXQgUGxhaW5TaGFkb3c7XG5cbmlmIChpc0FuZHJvaWQpIHtcbiAgTGF5ZXJlZFNoYWRvdyA9IGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuTGF5ZXJEcmF3YWJsZS5leHRlbmQoe30pO1xuICBQbGFpblNoYWRvdyA9IGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuR3JhZGllbnREcmF3YWJsZS5leHRlbmQoe30pO1xufVxuXG5jb25zdCBjbGFzc0NhY2hlOiB7IFtpZDogc3RyaW5nXTogeyBjbGFzczogYW55LCBmaWVsZENhY2hlOiB7IFtpZDogc3RyaW5nXTogbnVtYmVyIH0gfSB9ID0ge307XG4vLyBodHRwczovL2dpdGh1Yi5jb20vTmF0aXZlU2NyaXB0L2FuZHJvaWQtcnVudGltZS9pc3N1ZXMvMTMzMFxuZnVuY3Rpb24gZ2V0QW5kcm9pZFIocnR5cGU6IHN0cmluZywgZmllbGQ6IHN0cmluZyk6IG51bWJlciB7XG4gIGNvbnN0IGNsYXNzTmFtZSA9IFwiYW5kcm9pZC5SJFwiICsgcnR5cGU7XG4gIGlmICghY2xhc3NDYWNoZS5oYXNPd25Qcm9wZXJ0eShjbGFzc05hbWUpKSB7XG4gICAgY2xhc3NDYWNoZVtjbGFzc05hbWVdID0ge1xuICAgICAgY2xhc3M6IGphdmEubGFuZy5DbGFzcy5mb3JOYW1lKGNsYXNzTmFtZSksXG4gICAgICBmaWVsZENhY2hlOiB7fVxuICAgIH07XG4gIH1cbiAgaWYoIWNsYXNzQ2FjaGVbY2xhc3NOYW1lXS5maWVsZENhY2hlLmhhc093blByb3BlcnR5KGZpZWxkKSkge1xuICAgIGNsYXNzQ2FjaGVbY2xhc3NOYW1lXS5maWVsZENhY2hlW2ZpZWxkXSA9ICtjbGFzc0NhY2hlW2NsYXNzTmFtZV0uY2xhc3MuZ2V0RmllbGQoZmllbGQpLmdldChudWxsKTtcbiAgfVxuICByZXR1cm4gY2xhc3NDYWNoZVtjbGFzc05hbWVdLmZpZWxkQ2FjaGVbZmllbGRdO1xufVxuXG5leHBvcnQgY2xhc3MgU2hhZG93IHtcbiAgc3RhdGljIERFRkFVTFRfU0hBUEUgPSBTaGFwZUVudW0uUkVDVEFOR0xFO1xuICBzdGF0aWMgREVGQVVMVF9CR0NPTE9SID0gJyNGRkZGRkYnO1xuICBzdGF0aWMgREVGQVVMVF9TSEFET1dfQ09MT1IgPSAnIzAwMDAwMCc7XG4gIHN0YXRpYyBERUZBVUxUX1BSRVNTRURfRUxFVkFUSU9OID0gMjtcbiAgc3RhdGljIERFRkFVTFRfUFJFU1NFRF9aID0gNDtcblxuICBzdGF0aWMgYXBwbHkodG5zVmlldzogYW55LCBkYXRhOiBJT1NEYXRhIHwgQW5kcm9pZERhdGEpIHtcbiAgICBjb25zdCBMT0xMSVBPUCA9IDIxO1xuICAgIGlmIChcbiAgICAgIHRuc1ZpZXcuYW5kcm9pZCAmJlxuICAgICAgYW5kcm9pZC5vcy5CdWlsZC5WRVJTSU9OLlNES19JTlQgPj0gTE9MTElQT1BcbiAgICApIHtcbiAgICAgIFNoYWRvdy5hcHBseU9uQW5kcm9pZCh0bnNWaWV3LCBTaGFkb3cuZ2V0RGVmYXVsdHMoZGF0YSkpO1xuICAgIH0gZWxzZSBpZiAodG5zVmlldy5pb3MpIHtcbiAgICAgIFNoYWRvdy5hcHBseU9uSU9TKHRuc1ZpZXcsIFNoYWRvdy5nZXREZWZhdWx0cyhkYXRhKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0RGVmYXVsdHMoZGF0YTogSU9TRGF0YSB8IEFuZHJvaWREYXRhKSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIGRhdGEsXG4gICAgICB7XG4gICAgICAgIHNoYXBlOiAoZGF0YSBhcyBBbmRyb2lkRGF0YSkuc2hhcGUgfHwgU2hhZG93LkRFRkFVTFRfU0hBUEUsXG4gICAgICAgIHByZXNzZWRFbGV2YXRpb246IChkYXRhIGFzIEFuZHJvaWREYXRhKS5wcmVzc2VkRWxldmF0aW9uIHx8IFNoYWRvdy5ERUZBVUxUX1BSRVNTRURfRUxFVkFUSU9OLFxuICAgICAgICBwcmVzc2VkVHJhbnNsYXRpb25aOiAoZGF0YSBhcyBBbmRyb2lkRGF0YSkucHJlc3NlZFRyYW5zbGF0aW9uWiB8fCBTaGFkb3cuREVGQVVMVF9QUkVTU0VEX0VMRVZBVElPTixcbiAgICAgICAgc2hhZG93Q29sb3I6IChkYXRhIGFzIElPU0RhdGEpLnNoYWRvd0NvbG9yIHx8XG4gICAgICAgICAgU2hhZG93LkRFRkFVTFRfU0hBRE9XX0NPTE9SLFxuICAgICAgICB1c2VTaGFkb3dQYXRoOiAoKGRhdGEgYXMgSU9TRGF0YSkudXNlU2hhZG93UGF0aCAhPT0gdW5kZWZpbmVkID8gKGRhdGEgYXMgSU9TRGF0YSkudXNlU2hhZG93UGF0aCA6IHRydWUpLFxuICAgICAgICByYXN0ZXJpemU6ICgoZGF0YSBhcyBJT1NEYXRhKS5yYXN0ZXJpemUgIT09IHVuZGVmaW5lZCA/IChkYXRhIGFzIElPU0RhdGEpLnJhc3Rlcml6ZSA6IGZhbHNlKVxuICAgICAgfSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaXNTaGFkb3coZHJhd2FibGU6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoZHJhd2FibGUgaW5zdGFuY2VvZiBMYXllcmVkU2hhZG93IHx8IGRyYXdhYmxlIGluc3RhbmNlb2YgUGxhaW5TaGFkb3cpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgYXBwbHlPbkFuZHJvaWQodG5zVmlldzogYW55LCBkYXRhOiBBbmRyb2lkRGF0YSkge1xuICAgIGNvbnN0IG5hdGl2ZVZpZXcgPSB0bnNWaWV3LmFuZHJvaWQ7XG4gICAgbGV0IHNoYXBlO1xuICAgIGxldCBvdmVycmlkZUJhY2tncm91bmQgPSB0cnVlO1xuXG5cbiAgICBsZXQgY3VycmVudEJnID0gbmF0aXZlVmlldy5nZXRCYWNrZ3JvdW5kKCk7XG5cbiAgICBpZiAoY3VycmVudEJnIGluc3RhbmNlb2YgYW5kcm9pZC5ncmFwaGljcy5kcmF3YWJsZS5SaXBwbGVEcmF3YWJsZSkgeyAvLyBwbGF5IG5pY2UgaWYgYSByaXBwbGUgaXMgd3JhcHBpbmcgYSBzaGFkb3dcbiAgICAgIGxldCByaXBwbGVCZyA9IGN1cnJlbnRCZy5nZXREcmF3YWJsZSgwKTtcbiAgICAgIGlmIChyaXBwbGVCZyBpbnN0YW5jZW9mIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuSW5zZXREcmF3YWJsZSkge1xuICAgICAgICBvdmVycmlkZUJhY2tncm91bmQgPSBmYWxzZTsgLy8gdGhpcyBpcyBhIGJ1dHRvbiB3aXRoIGl0J3Mgb3duIHNoYWRvd1xuICAgICAgfSBlbHNlIGlmIChTaGFkb3cuaXNTaGFkb3cocmlwcGxlQmcpKSB7IC8vIGlmIHRoZSByaXBwbGUgaXMgd3JhcHBpbmcgYSBzaGFkb3csIHN0cmlwIGl0XG4gICAgICAgIGN1cnJlbnRCZyA9IHJpcHBsZUJnO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3ZlcnJpZGVCYWNrZ3JvdW5kKSB7XG4gICAgICBpZiAoU2hhZG93LmlzU2hhZG93KGN1cnJlbnRCZykpIHsgLy8gbWFrZSBzdXJlIHRvIGhhdmUgdGhlIHJpZ2h0IGJhY2tncm91bmRcbiAgICAgICAgY3VycmVudEJnID0gY3VycmVudEJnIGluc3RhbmNlb2YgTGF5ZXJlZFNoYWRvdyA/IC8vIGlmIGxheWVyZWQsIGdldCB0aGUgb3JpZ2luYWwgYmFja2dyb3VuZFxuICAgICAgICAgIGN1cnJlbnRCZy5nZXREcmF3YWJsZSgxKSA6IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG91dGVyUmFkaWkgPSBBcnJheS5jcmVhdGUoXCJmbG9hdFwiLCA4KTtcbiAgICAgIGlmIChkYXRhLmNvcm5lclJhZGl1cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG91dGVyUmFkaWlbMF0gPSBvdXRlclJhZGlpWzFdID0gTGVuZ3RoLnRvRGV2aWNlUGl4ZWxzKHRuc1ZpZXcuYm9yZGVyVG9wTGVmdFJhZGl1cywgMCk7XG4gICAgICAgIG91dGVyUmFkaWlbMl0gPSBvdXRlclJhZGlpWzNdID0gTGVuZ3RoLnRvRGV2aWNlUGl4ZWxzKHRuc1ZpZXcuYm9yZGVyVG9wUmlnaHRSYWRpdXMsIDApO1xuICAgICAgICBvdXRlclJhZGlpWzRdID0gb3V0ZXJSYWRpaVs1XSA9IExlbmd0aC50b0RldmljZVBpeGVscyh0bnNWaWV3LmJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzLCAwKTtcbiAgICAgICAgb3V0ZXJSYWRpaVs2XSA9IG91dGVyUmFkaWlbN10gPSBMZW5ndGgudG9EZXZpY2VQaXhlbHModG5zVmlldy5ib3JkZXJCb3R0b21MZWZ0UmFkaXVzLCAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGphdmEudXRpbC5BcnJheXMuZmlsbChvdXRlclJhZGlpLCBTaGFkb3cuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS5jb3JuZXJSYWRpdXMgYXMgbnVtYmVyKSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHVzZSB0aGUgdXNlciBkZWZpbmVkIGNvbG9yIG9yIHRoZSBkZWZhdWx0IGluIGNhc2UgdGhlIGNvbG9yIGlzIFRSQU5TUEFSRU5UXG4gICAgICBjb25zdCBiZ0NvbG9yID0gY3VycmVudEJnID9cbiAgICAgICAgKGN1cnJlbnRCZyBpbnN0YW5jZW9mIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuQ29sb3JEcmF3YWJsZSAmJiBjdXJyZW50QmcuZ2V0Q29sb3IoKSA/XG4gICAgICAgICAgY3VycmVudEJnLmdldENvbG9yKCkgOiBhbmRyb2lkLmdyYXBoaWNzLkNvbG9yLnBhcnNlQ29sb3IoZGF0YS5iZ2NvbG9yIHx8IFNoYWRvdy5ERUZBVUxUX0JHQ09MT1IpKSA6XG4gICAgICAgIGFuZHJvaWQuZ3JhcGhpY3MuQ29sb3IucGFyc2VDb2xvcihkYXRhLmJnY29sb3IgfHwgU2hhZG93LkRFRkFVTFRfQkdDT0xPUik7XG5cbiAgICAgIGxldCBuZXdCZztcblxuICAgICAgaWYgKGRhdGEuc2hhcGUgIT09IFNoYXBlRW51bS5SRUNUQU5HTEUgfHwgZGF0YS5iZ2NvbG9yIHx8ICFjdXJyZW50QmcpIHsgLy8gcmVwbGFjZSBiYWNrZ3JvdW5kXG4gICAgICAgIHNoYXBlID0gbmV3IFBsYWluU2hhZG93KCk7XG4gICAgICAgIHNoYXBlLnNldFNoYXBlKFxuICAgICAgICAgIGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuR3JhZGllbnREcmF3YWJsZVtkYXRhLnNoYXBlXSxcbiAgICAgICAgKTtcbiAgICAgICAgc2hhcGUuc2V0Q29ybmVyUmFkaWkob3V0ZXJSYWRpaSk7XG4gICAgICAgIHNoYXBlLnNldENvbG9yKGJnQ29sb3IpO1xuICAgICAgICBuZXdCZyA9IHNoYXBlO1xuICAgICAgfSBlbHNlIHsgLy8gYWRkIGEgbGF5ZXJcbiAgICAgICAgY29uc3QgciA9IG5ldyBhbmRyb2lkLmdyYXBoaWNzLmRyYXdhYmxlLnNoYXBlcy5Sb3VuZFJlY3RTaGFwZShvdXRlclJhZGlpLCBudWxsLCBudWxsKTtcbiAgICAgICAgc2hhcGUgPSBuZXcgYW5kcm9pZC5ncmFwaGljcy5kcmF3YWJsZS5TaGFwZURyYXdhYmxlKHIpO1xuICAgICAgICBzaGFwZS5nZXRQYWludCgpLnNldENvbG9yKGJnQ29sb3IpO1xuICAgICAgICB2YXIgYXJyID0gQXJyYXkuY3JlYXRlKGFuZHJvaWQuZ3JhcGhpY3MuZHJhd2FibGUuRHJhd2FibGUsIDIpO1xuICAgICAgICBhcnJbMF0gPSBzaGFwZTtcbiAgICAgICAgYXJyWzFdID0gY3VycmVudEJnO1xuICAgICAgICBjb25zdCBkcmF3YWJsZSA9IG5ldyBMYXllcmVkU2hhZG93KGFycik7XG4gICAgICAgIG5ld0JnID0gZHJhd2FibGU7XG4gICAgICB9XG5cbiAgICAgIG5hdGl2ZVZpZXcuc2V0QmFja2dyb3VuZERyYXdhYmxlKG5ld0JnKTtcbiAgICB9XG5cbiAgICBuYXRpdmVWaWV3LnNldEVsZXZhdGlvbihcbiAgICAgIFNoYWRvdy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLmVsZXZhdGlvbiBhcyBudW1iZXIpLFxuICAgICk7XG4gICAgbmF0aXZlVmlldy5zZXRUcmFuc2xhdGlvblooXG4gICAgICBTaGFkb3cuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS50cmFuc2xhdGlvblogYXMgbnVtYmVyKSxcbiAgICApO1xuICAgIGlmIChuYXRpdmVWaWV3LmdldFN0YXRlTGlzdEFuaW1hdG9yKCkgfHwgZGF0YS5mb3JjZVByZXNzQW5pbWF0aW9uKSB7XG4gICAgICB0aGlzLm92ZXJyaWRlRGVmYXVsdEFuaW1hdG9yKG5hdGl2ZVZpZXcsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIG92ZXJyaWRlRGVmYXVsdEFuaW1hdG9yKG5hdGl2ZVZpZXc6IGFueSwgZGF0YTogQW5kcm9pZERhdGEpIHtcbiAgICBjb25zdCBzbGEgPSBuZXcgYW5kcm9pZC5hbmltYXRpb24uU3RhdGVMaXN0QW5pbWF0b3IoKTtcblxuICAgIGNvbnN0IE9iamVjdEFuaW1hdG9yID0gYW5kcm9pZC5hbmltYXRpb24uT2JqZWN0QW5pbWF0b3I7XG4gICAgY29uc3QgQW5pbWF0b3JTZXQgPSBhbmRyb2lkLmFuaW1hdGlvbi5BbmltYXRvclNldDtcbiAgICBjb25zdCBzaG9ydEFuaW1UaW1lID0gZ2V0QW5kcm9pZFIoXCJpbnRlZ2VyXCIsIFwiY29uZmlnX3Nob3J0QW5pbVRpbWVcIik7XG5cbiAgICBjb25zdCBidXR0b25EdXJhdGlvbiA9XG4gICAgICBuYXRpdmVWaWV3LmdldENvbnRleHQoKS5nZXRSZXNvdXJjZXMoKS5nZXRJbnRlZ2VyKHNob3J0QW5pbVRpbWUpIC8gMjtcbiAgICBjb25zdCBwcmVzc2VkRWxldmF0aW9uID0gdGhpcy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLnByZXNzZWRFbGV2YXRpb24pO1xuICAgIGNvbnN0IHByZXNzZWRaID0gdGhpcy5hbmRyb2lkRGlwVG9QeChuYXRpdmVWaWV3LCBkYXRhLnByZXNzZWRUcmFuc2xhdGlvblopO1xuICAgIGNvbnN0IGVsZXZhdGlvbiA9IHRoaXMuYW5kcm9pZERpcFRvUHgobmF0aXZlVmlldywgZGF0YS5lbGV2YXRpb24pO1xuICAgIGNvbnN0IHogPSB0aGlzLmFuZHJvaWREaXBUb1B4KG5hdGl2ZVZpZXcsIGRhdGEudHJhbnNsYXRpb25aIHx8IDApO1xuXG4gICAgY29uc3QgcHJlc3NlZFNldCA9IG5ldyBBbmltYXRvclNldCgpO1xuICAgIGNvbnN0IG5vdFByZXNzZWRTZXQgPSBuZXcgQW5pbWF0b3JTZXQoKTtcbiAgICBjb25zdCBkZWZhdWx0U2V0ID0gbmV3IEFuaW1hdG9yU2V0KCk7XG5cbiAgICBwcmVzc2VkU2V0LnBsYXlUb2dldGhlcihqYXZhLnV0aWwuQXJyYXlzLmFzTGlzdChbXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwidHJhbnNsYXRpb25aXCIsIFtwcmVzc2VkWl0pXG4gICAgICAgIC5zZXREdXJhdGlvbihidXR0b25EdXJhdGlvbiksXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwiZWxldmF0aW9uXCIsIFtwcmVzc2VkRWxldmF0aW9uXSlcbiAgICAgICAgLnNldER1cmF0aW9uKDApLFxuICAgIF0pKTtcbiAgICBub3RQcmVzc2VkU2V0LnBsYXlUb2dldGhlcihqYXZhLnV0aWwuQXJyYXlzLmFzTGlzdChbXG4gICAgICBPYmplY3RBbmltYXRvci5vZkZsb2F0KG5hdGl2ZVZpZXcsIFwidHJhbnNsYXRpb25aXCIsIFt6XSlcbiAgICAgICAgLnNldER1cmF0aW9uKGJ1dHRvbkR1cmF0aW9uKSxcbiAgICAgIE9iamVjdEFuaW1hdG9yLm9mRmxvYXQobmF0aXZlVmlldywgXCJlbGV2YXRpb25cIiwgW2VsZXZhdGlvbl0pXG4gICAgICAgIC5zZXREdXJhdGlvbigwKSxcbiAgICBdKSk7XG4gICAgZGVmYXVsdFNldC5wbGF5VG9nZXRoZXIoamF2YS51dGlsLkFycmF5cy5hc0xpc3QoW1xuICAgICAgT2JqZWN0QW5pbWF0b3Iub2ZGbG9hdChuYXRpdmVWaWV3LCBcInRyYW5zbGF0aW9uWlwiLCBbMF0pLnNldER1cmF0aW9uKDApLFxuICAgICAgT2JqZWN0QW5pbWF0b3Iub2ZGbG9hdChuYXRpdmVWaWV3LCBcImVsZXZhdGlvblwiLCBbMF0pLnNldER1cmF0aW9uKDApLFxuICAgIF0pKTtcblxuICAgIHNsYS5hZGRTdGF0ZShcbiAgICAgIFtnZXRBbmRyb2lkUihcImF0dHJcIiwgXCJzdGF0ZV9wcmVzc2VkXCIpLCBnZXRBbmRyb2lkUihcImF0dHJcIiwgXCJzdGF0ZV9lbmFibGVkXCIpXSxcbiAgICAgIHByZXNzZWRTZXQsXG4gICAgKTtcbiAgICBzbGEuYWRkU3RhdGUoW2dldEFuZHJvaWRSKFwiYXR0clwiLCBcInN0YXRlX2VuYWJsZWRcIildLCBub3RQcmVzc2VkU2V0KTtcbiAgICBzbGEuYWRkU3RhdGUoW10sIGRlZmF1bHRTZXQpO1xuICAgIG5hdGl2ZVZpZXcuc2V0U3RhdGVMaXN0QW5pbWF0b3Ioc2xhKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGFwcGx5T25JT1ModG5zVmlldzogYW55LCBkYXRhOiBJT1NEYXRhKSB7XG4gICAgY29uc3QgbmF0aXZlVmlldyA9IHRuc1ZpZXcuaW9zO1xuICAgIGNvbnN0IGVsZXZhdGlvbiA9IHBhcnNlRmxvYXQoKChkYXRhLmVsZXZhdGlvbiBhcyBudW1iZXIpIC0gMCkudG9GaXhlZCgyKSk7XG4gICAgbmF0aXZlVmlldy5sYXllci5tYXNrVG9Cb3VuZHMgPSBmYWxzZTtcbiAgICBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd0NvbG9yID0gbmV3IENvbG9yKGRhdGEuc2hhZG93Q29sb3IpLmlvcy5DR0NvbG9yO1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93T2Zmc2V0ID1cbiAgICAgIGRhdGEuc2hhZG93T2Zmc2V0ID9cbiAgICAgICAgQ0dTaXplTWFrZSgwLCBwYXJzZUZsb2F0KFN0cmluZyhkYXRhLnNoYWRvd09mZnNldCkpKSA6XG4gICAgICAgIENHU2l6ZU1ha2UoMCwgMC41NCAqIGVsZXZhdGlvbiAtIDAuMTQpO1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hhZG93T3BhY2l0eSA9XG4gICAgICBkYXRhLnNoYWRvd09wYWNpdHkgP1xuICAgICAgICBwYXJzZUZsb2F0KFN0cmluZyhkYXRhLnNoYWRvd09wYWNpdHkpKSA6XG4gICAgICAgIDAuMDA2ICogZWxldmF0aW9uICsgMC4yNTtcbiAgICBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd1JhZGl1cyA9XG4gICAgICBkYXRhLnNoYWRvd1JhZGl1cyA/XG4gICAgICAgIHBhcnNlRmxvYXQoU3RyaW5nKGRhdGEuc2hhZG93UmFkaXVzKSkgOlxuICAgICAgICAwLjY2ICogZWxldmF0aW9uIC0gMC41O1xuICAgIG5hdGl2ZVZpZXcubGF5ZXIuc2hvdWxkUmFzdGVyaXplID0gZGF0YS5yYXN0ZXJpemU7XG4gICAgbmF0aXZlVmlldy5sYXllci5yYXN0ZXJpemF0aW9uU2NhbGUgPSBzY3JlZW4ubWFpblNjcmVlbi5zY2FsZTtcbiAgICBsZXQgc2hhZG93UGF0aCA9IG51bGw7XG4gICAgaWYgKGRhdGEudXNlU2hhZG93UGF0aCkge1xuICAgICAgc2hhZG93UGF0aCA9IFVJQmV6aWVyUGF0aC5iZXppZXJQYXRoV2l0aFJvdW5kZWRSZWN0Q29ybmVyUmFkaXVzKG5hdGl2ZVZpZXcuYm91bmRzLCBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd1JhZGl1cykuY2dQYXRoO1xuICAgIH1cbiAgICBuYXRpdmVWaWV3LmxheWVyLnNoYWRvd1BhdGggPSBzaGFkb3dQYXRoO1xuICB9XG5cbiAgc3RhdGljIGFuZHJvaWREaXBUb1B4KG5hdGl2ZVZpZXc6IGFueSwgZGlwOiBudW1iZXIpIHtcbiAgICBjb25zdCBtZXRyaWNzID0gbmF0aXZlVmlldy5nZXRDb250ZXh0KCkuZ2V0UmVzb3VyY2VzKCkuZ2V0RGlzcGxheU1ldHJpY3MoKTtcbiAgICByZXR1cm4gYW5kcm9pZC51dGlsLlR5cGVkVmFsdWUuYXBwbHlEaW1lbnNpb24oXG4gICAgICBhbmRyb2lkLnV0aWwuVHlwZWRWYWx1ZS5DT01QTEVYX1VOSVRfRElQLFxuICAgICAgZGlwLFxuICAgICAgbWV0cmljcyxcbiAgICApO1xuICB9XG59XG4iXX0=